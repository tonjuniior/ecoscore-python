{% extends "base.html" %}

{% block title %}Meu Desempenho{% endblock %}

{% block content %}
<style>
    .summary {
        display: flex;
        justify-content: space-around;
        text-align: center;
        margin: 20px 0;
        background-color: var(--surface-dark);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 15px 0;
    }
    .summary-item {
        width: 45%;
    }
    .summary-item strong {
        color: var(--text-light);
    }
    .summary-item span {
        color: var(--text-muted);
    }

    .history-table {
        width: 100%;
        background-color: var(--surface-dark);
        color: var(--text-light);
    }
    .history-table th {
        background-color: #333;
        color: var(--text-light);
    }
    .history-table td {
        border-bottom: 1px solid var(--border-color);
    }
    .history-table tr:last-child td {
        border-bottom: none;
    }
</style>
    <h2>Meu Desempenho</h2>

    {% if dados %}
        <div class="summary">
            <div class="summary-item">
                <span>Pontuação Total</span>
                <strong>{{ '%+d'|format(dados.pontuacao_total) }}</strong>
            </div>
            <div class="summary-item">
                <span>Média Diária (EcoScore)</span>
                <strong>{{ '%.2f'|format(dados.media_diaria) }}</strong>
            </div>
        </div>

        <h3>Análise de Desempenho</h3>
        <div style="display: flex; flex-wrap: wrap; gap: 20px; margin-bottom: 30px;">
            <div style="flex: 1; min-width: 300px;">
                <h4>Evolução da Pontuação (Últimos 30 dias)</h4>
                <canvas id="performanceChart"></canvas>
            </div>
            <div style="flex: 1; min-width: 300px;">
                <h4>Média por Categoria</h4>
                <canvas id="categoryChart"></canvas>
            </div>
        </div>

        <h3>Últimos 5 Registros</h3>
        <table class="history-table">
            <thead>
                <tr>
                    <th>Data</th>
                    <th>Pontuação do Dia</th>
                </tr>
            </thead>
            <tbody>
                {% for registro in dados.historico_recente|reverse %}
                <tr>
                    <td>{{ registro.data }}</td>
                    <td>{{ '%+d'|format(registro.pontuacao) }} pts</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    {% else %}
        <div class="flash info">Você ainda não possui registros. Preencha o formulário de hábitos para começar!</div>
    {% endif %}
    <br>
    <a href="{{ url_for('menu') }}" class="btn btn-secondary">Voltar ao Menu</a>

    {% if dados and dados.chart_labels %}
    <!-- 1. Inclui a biblioteca Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- 2. Script para configurar e renderizar o gráfico -->
    <script>
        const ctx = document.getElementById('performanceChart');

        new Chart(ctx, {
            type: 'line', // Tipo do gráfico (linha)
            data: {
                // Passa os dados do Flask para o JavaScript de forma segura
                labels: {{ dados.chart_labels|tojson }},
                datasets: [{
                    label: 'Pontuação Diária',
                    data: {{ dados.chart_data|tojson }},
                    fill: 'start',
                    borderColor: 'var(--primary-green)',
                    backgroundColor: 'rgba(39, 174, 96, 0.2)',
                    tension: 0.1
                }]
            },
            options: {
                scales: {
                    y: {
                        beginAtZero: false, // Permite que o eixo Y comece abaixo de zero
                        ticks: { color: 'var(--text-muted)' },
                        grid: { color: 'rgba(255, 255, 255, 0.1)' }
                    },
                    x: {
                        ticks: { color: 'var(--text-muted)' },
                        grid: { color: 'rgba(255, 255, 255, 0.1)' }
                    }
                },
                plugins: {
                    legend: {
                        display: false,
                        labels: { color: 'var(--text-light)' }
                    }
                }
            }
        });

        const categoryCtx = document.getElementById('categoryChart');
        new Chart(categoryCtx, {
            type: 'radar',
            data: {
                labels: {{ dados.category_chart_labels|tojson }},
                datasets: [{
                    label: 'Média de Pontos',
                    data: {{ dados.category_chart_data|tojson }},
                    fill: true,
                    backgroundColor: 'rgba(39, 174, 96, 0.2)',
                    borderColor: 'var(--primary-green)',
                    pointBackgroundColor: 'var(--primary-green)',
                    pointBorderColor: '#fff',
                    pointHoverBackgroundColor: '#fff',
                    pointHoverBorderColor: 'var(--primary-green)'
                }]
            },
            options: {
                elements: {
                    line: {
                        borderWidth: 2
                    }
                },
                scales: {
                    r: {
                        angleLines: { color: 'rgba(255, 255, 255, 0.2)' },
                        grid: { color: 'rgba(255, 255, 255, 0.2)' },
                        pointLabels: {
                            color: 'var(--text-light)',
                            font: {
                                size: 12
                            }
                        },
                        ticks: {
                            color: 'var(--text-muted)',
                            backdropColor: 'rgba(0, 0, 0, 0.5)',
                            backdropPadding: 4
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    }
                }
            }
        });
    </script>
    {% endif %}
{% endblock %}